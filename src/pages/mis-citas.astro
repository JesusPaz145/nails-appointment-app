---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Mis Citas">
    <div class="container" style="padding: 4rem 1rem;">
        <h1 class="text-center" style="color: var(--color-primary); margin-bottom: 2rem;">Mis Citas</h1>

        <div class="card" style="max-width: 800px; margin: 0 auto; overflow-x: auto;">
             <table style="width: 100%; border-collapse: collapse; min-width: 500px;">
                <thead>
                    <tr style="background-color: #f9fafb; text-align: left;">
                        <th style="padding: 1rem; border-bottom: 2px solid #eee;">Fecha</th>
                        <th style="padding: 1rem; border-bottom: 2px solid #eee;">Hora</th>
                        <th style="padding: 1rem; border-bottom: 2px solid #eee;">Servicio</th>
                        <th style="padding: 1rem; border-bottom: 2px solid #eee;">Estado</th>
                    </tr>
                </thead>
                <tbody id="citas-table-body">
                    <tr>
                        <td colspan="4" class="text-center" style="padding: 2rem;">Cargando tus citas...</td>
                    </tr>
                </tbody>
            </table>
             <div style="margin-top: 2rem; text-align: center;">
                <a href="/servicios" class="btn btn-primary">Reservar Nueva Cita</a>
            </div>
        </div>
    </div>
</Layout>

<script>
    import { api } from '../utils/api';
    import { checkAuth } from '../utils/auth';

    const tableBody = document.getElementById('citas-table-body');

    async function init() {
        // Redirect if not logged in
        const user = await checkAuth();
        if (!user) {
            window.location.href = '/login';
            return;
        }

        loadCitas();
    }

    async function loadCitas() {
        try {
            const citas = await api.get('/citas');
            
            if (citas.length === 0) {
                tableBody!.innerHTML = '<tr><td colspan="4" class="text-center" style="padding: 2rem;">No tienes citas agendadas a√∫n.</td></tr>';
                return;
            }

            tableBody!.innerHTML = citas.map((c: any) => {
                const date = new Date(c.fecha_cita).toLocaleDateString('es-ES', { 
                    weekday: 'short', 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                const time = c.hora_inicio.slice(0, 5);

                const statusColor = c.estado === 'cancelada' ? '#ef4444' : 
                                   (c.estado === 'completada' || c.estado === 'confirmada') ? '#22c55e' : '#f59e0b';
                
                const statusLabel = c.estado.charAt(0).toUpperCase() + c.estado.slice(1);

                return `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 1rem;">${date}</td>
                        <td style="padding: 1rem; font-weight: bold;">${time}</td>
                        <td style="padding: 1rem;">${c.nombre_servicio || 'Servicio Desconocido'}</td>
                        <td style="padding: 1rem;">
                            <span style="padding: 0.25rem 0.75rem; border-radius: 99px; background-color: ${statusColor}20; color: ${statusColor}; font-weight: 600; font-size: 0.9rem;">
                                ${statusLabel}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');

        } catch (err) {
            console.error(err);
            tableBody!.innerHTML = '<tr><td colspan="4" class="text-center" style="padding: 2rem; color: var(--color-error);">Error al cargar tus citas.</td></tr>';
        }
    }

    init();
</script>
