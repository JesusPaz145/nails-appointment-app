---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Gestionar Servicios">
    <div class="container" style="padding: 4rem 1rem;">
        <div class="flex justify-between items-center mb-2">
            <h1 style="color: var(--color-primary);">Gestionar Servicios</h1>
            <button id="btn-add" class="btn btn-primary">+ Nuevo Servicio</button>
        </div>
        
        <div id="services-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;">
            <!-- Services injected here -->
        </div>
    </div>

    <!-- Modal for Add/Edit -->
    <div id="modal" class="modal" style="display: none;">
        <div class="modal-content card">
            <span id="close-modal" style="float: right; cursor: pointer; font-size: 1.5rem;">&times;</span>
            <h2 id="modal-title" style="margin-bottom: 1rem;">Nuevo Servicio</h2>
            <form id="service-form">
                <input type="hidden" id="service-id" name="id">
                <div class="mb-2">
                    <label>Nombre del Servicio</label>
                    <input type="text" name="nombre_servicio" required style="width: 100%; padding: 0.5rem;">
                </div>
                <div class="mb-2">
                    <label>Descripción</label>
                    <textarea name="descripcion" style="width: 100%; padding: 0.5rem; height: 80px;" placeholder="Detalles del servicio..."></textarea>
                </div>
                <div class="mb-2">
                    <label>Precio</label>
                    <input type="number" name="precio" step="0.01" required style="width: 100%; padding: 0.5rem;">
                </div>
                <div class="mb-2">
                    <label>Duración (minutos)</label>
                    <input type="number" name="duracion_minutos" required style="width: 100%; padding: 0.5rem;">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Guardar</button>
            </form>
        </div>
    </div>
</Layout>

<style>
    .modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 1000;
        display: none; justify-content: center; align-items: center;
    }
    .modal-content {
        background: white; width: 90%; max-width: 500px; padding: 2rem; border-radius: 10px;
    }
</style>

<script>
    import { api } from '../../utils/api';
    import { checkAuth } from '../../utils/auth';

    const list = document.getElementById('services-list');
    const modal = document.getElementById('modal');
    const form = document.getElementById('service-form');
    const modalTitle = document.getElementById('modal-title');
    const btnAdd = document.getElementById('btn-add');
    const closeBtn = document.getElementById('close-modal');

    // Protect route and load data
    async function init() {
        const user = await checkAuth();
        if (!user || user.usr_lvl !== 1) {
            window.location.href = '/';
            return;
        }
        loadServices();
    }

    async function loadServices() {
        if (!list) return;
        try {
            const services = await api.get('/servicios');
            list.innerHTML = services.map(s => `
                <div class="card">
                    <h3>${s.nombre_servicio}</h3>
                    <p style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">${s.descripcion || ''}</p>
                    <p>Precio: $${s.precio}</p>
                    <p>Duración: ${s.duracion_minutos} min</p>
                    <div class="flex gap-2 mt-2">
                        <button class="btn btn-secondary" onclick="editService(${s.id}, '${s.nombre_servicio}', ${s.precio}, ${s.duracion_minutos}, '${(s.descripcion || '').replace(/'/g, "\\'")}')">Editar</button>
                        <button class="btn" style="background: #ff6b6b; color: white;" onclick="deleteService(${s.id})">Eliminar</button>
                    </div>
                </div>
            `).join('');
        } catch (err) {
            console.error(err);
        }
    }

    // Modal Logic
    if (btnAdd) btnAdd.onclick = () => {
        openModal();
    };
    if (closeBtn) closeBtn.onclick = () => {
        if(modal) modal.style.display = 'none';
    };
    window.onclick = (e) => {
        if (e.target == modal && modal) modal.style.display = 'none';
    };

    function openModal(isEdit = false) {
        if (!modal || !modalTitle || !form) return;
        modal.style.display = 'flex';
        modalTitle.textContent = isEdit ? 'Editar Servicio' : 'Nuevo Servicio';
        if (!isEdit) {
            (form as HTMLFormElement).reset();
            (document.getElementById('service-id') as HTMLInputElement).value = '';
        }
    }

    // Expose functions to window for inline onclicks
    (window as any).editService = (id, nombre, precio, duracion, descripcion) => {
        openModal(true);
        const f = document.getElementById('service-form') as HTMLFormElement;
        f.id.value = id;
        f.nombre_servicio.value = nombre;
        f.precio.value = precio;
        f.duracion_minutos.value = duracion;
        (f.descripcion as HTMLTextAreaElement).value = descripcion || '';
    };

    (window as any).deleteService = async (id) => {
        if(confirm('¿Seguro de eliminar este servicio?')) {
            try {
                await api.delete(`/servicios/${id}`);
                loadServices();
            } catch (err) {
                alert('Error eliminando servicio');
            }
        }
    };

    form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(form as HTMLFormElement);
        const data = Object.fromEntries(formData);
        const id = data.id;

        try {
            if (id) {
                await api.put(`/servicios/${id}`, data);
            } else {
                await api.post('/servicios', data);
            }
            if(modal) modal.style.display = 'none';
            loadServices();
        } catch (err: any) {
            alert(err.message);
        }
    });

    init();
</script>
