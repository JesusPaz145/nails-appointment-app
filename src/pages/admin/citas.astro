---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Administrar Citas">
    <div class="container" style="padding: 4rem 1rem;">
        <div class="flex justify-between items-center mb-2">
            <h1 style="color: var(--color-primary);">üìÖ Gesti√≥n de Citas</h1>
            <a href="/admin" class="btn btn-secondary">‚Üê Volver al Panel</a>
        </div>

        <div class="card" style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; min-width: 600px;">
                <thead>
                    <tr style="background-color: #f9fafb; text-align: left;">
                        <th style="padding: 1rem; border-bottom: 2px solid #eee;">Fecha</th>
                        <th style="padding: 1rem; border-bottom: 2px solid #eee;">Hora</th>
                        <th style="padding: 1rem; border-bottom: 2px solid #eee;">Cliente</th>
                        <th style="padding: 1rem; border-bottom: 2px solid #eee;">Servicio</th>
                        <th style="padding: 1rem; border-bottom: 2px solid #eee;">Contacto</th>
                        <th style="padding: 1rem; border-bottom: 2px solid #eee;">Estado</th>
                    </tr>
                </thead>
                <tbody id="citas-table-body">
                    <tr>
                        <td colspan="6" class="text-center" style="padding: 2rem;">Cargando citas...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</Layout>

<script>
    import { api } from '../../utils/api';
    import { checkAuth } from '../../utils/auth';

    const tableBody = document.getElementById('citas-table-body');

    async function init() {
        const user = await checkAuth();
        if (!user || user.usr_lvl !== 1) {
            window.location.href = '/';
            return;
        }

        loadCitas();
    }

    async function loadCitas() {
        try {
            const citas = await api.get('/citas');
            
            if (citas.length === 0) {
                tableBody!.innerHTML = '<tr><td colspan="6" class="text-center" style="padding: 2rem;">No hay citas registradas.</td></tr>';
                return;
            }

            tableBody!.innerHTML = citas.map((c: any) => {
                const date = new Date(c.fecha_cita).toLocaleDateString('es-ES', { 
                    weekday: 'short', 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                // Format time (HH:MM:SS -> HH:MM)
                const time = c.hora_inicio.slice(0, 5);

                const statusColor = c.estado === 'cancelada' ? '#ef4444' : 
                                   (c.estado === 'completada' || c.estado === 'confirmada') ? '#22c55e' : '#f59e0b';

                return `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 1rem;">${date}</td>
                        <td style="padding: 1rem; font-weight: bold;">${time}</td>
                        <td style="padding: 1rem;">
                            <div style="font-weight: 600;">${c.cliente_nombre}</div>
                            ${c.user_name ? `<span style="font-size: 0.8rem; color: #666;">(User: ${c.user_name})</span>` : ''}
                        </td>
                        <td style="padding: 1rem;">${c.nombre_servicio || 'Servicio Eliminado'}</td>
                        <td style="padding: 1rem;">
                            <div style="font-size: 0.9rem;">üìû ${c.cliente_telefono}</div>
                            <div style="font-size: 0.9rem;">‚úâÔ∏è ${c.cliente_email || '-'}</div>
                        </td>
                        <td style="padding: 1rem;">
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <span style="padding: 0.25rem 0.75rem; border-radius: 99px; background-color: ${statusColor}20; color: ${statusColor}; font-weight: 600; font-size: 0.9rem;">
                                    ${c.estado.charAt(0).toUpperCase() + c.estado.slice(1)}
                                </span>
                                ${c.estado === 'pendiente' ? `
                                    <button class="action-btn" data-id="${c.id}" data-action="confirmada" style="background: none; border: none; cursor: pointer; font-size: 1.2rem;" title="Aprobar">‚úÖ</button>
                                    <button class="action-btn" data-id="${c.id}" data-action="cancelada" style="background: none; border: none; cursor: pointer; font-size: 1.2rem;" title="Rechazar">‚ùå</button>
                                ` : ''}
                                ${c.estado === 'confirmada' ? `
                                    <button class="action-btn" data-id="${c.id}" data-action="completada" style="background: none; border: none; cursor: pointer; font-size: 1.2rem;" title="Marcar completada">üèÅ</button>
                                    <button class="action-btn" data-id="${c.id}" data-action="cancelada" style="background: none; border: none; cursor: pointer; font-size: 1.2rem;" title="Cancelar">‚ùå</button>
                                ` : ''}
                             </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Add listeners
            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.addEventListener('click', async (e: any) => {
                    if(!confirm('¬øEst√°s seguro de cambiar el estado?')) return;
                    
                    const id = e.target.getAttribute('data-id');
                    const estado = e.target.getAttribute('data-action');
                    
                    try {
                        await api.put(`/citas/${id}`, { estado });
                        loadCitas(); // Reload
                    } catch (err) {
                        alert('Error al actualizar estado');
                    }
                });
            });

        } catch (err) {
            console.error(err);
            tableBody!.innerHTML = '<tr><td colspan="6" class="text-center" style="padding: 2rem; color: var(--color-error);">Error al cargar las citas.</td></tr>';
        }
    }

    init();
</script>
