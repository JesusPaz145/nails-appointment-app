{% extends "base.html" %}

{% block title %}Admin Dashboard | Nails by Anais{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 pt-24 pb-12 px-4">
    <div class="container mx-auto max-w-6xl">
        <h1 class="text-4xl font-serif font-bold text-gray-800 mb-8 text-center text-primary">Admin Dashboard</h1>

        <!-- Navigation Tabs -->
        <div class="bg-white rounded-2xl shadow-sm p-2 mb-8 flex flex-wrap justify-center gap-2">
            <button onclick="switchAdminTab('citas')" id="btn-citas"
                class="px-6 py-3 rounded-xl font-bold transition-all bg-primary text-white shadow-md">
                <i class="fas fa-calendar-check mr-2"></i> Reservas
            </button>
            <button onclick="switchAdminTab('horarios')" id="btn-horarios"
                class="px-6 py-3 rounded-xl font-bold transition-all text-gray-500 hover:text-primary hover:bg-pink-50">
                <i class="fas fa-clock mr-2"></i> Horarios
            </button>
            <button onclick="switchAdminTab('bloqueos')" id="btn-bloqueos"
                class="px-6 py-3 rounded-xl font-bold transition-all text-gray-500 hover:text-primary hover:bg-pink-50">
                <i class="fas fa-ban mr-2"></i> D√≠as Bloqueados
            </button>
            <button onclick="switchAdminTab('users')" id="btn-users"
                class="px-6 py-3 rounded-xl font-bold transition-all text-gray-500 hover:text-primary hover:bg-pink-50">
                <i class="fas fa-users mr-2"></i> Usuarios
            </button>
        </div>

        <!-- Content Sections -->

        <!-- CITAS SECTION -->
        <div id="tab-citas" class="space-y-6">
            <!-- Sub-tabs for Citas filters -->
            <div class="flex flex-wrap justify-center gap-2 mb-4">
                <button onclick="filterCitas('hoy')" id="filter-hoy"
                    class="px-4 py-2 rounded-lg font-bold text-sm bg-primary text-white shadow transition-all">
                    üìÖ Hoy
                </button>
                <button onclick="filterCitas('pendiente')" id="filter-pendiente"
                    class="px-4 py-2 rounded-lg font-bold text-sm bg-white text-gray-500 hover:text-primary border border-gray-100 transition-all">
                    ‚è≥ Pendientes
                </button>
                <button onclick="filterCitas('completada')" id="filter-completada"
                    class="px-4 py-2 rounded-lg font-bold text-sm bg-white text-gray-500 hover:text-primary border border-gray-100 transition-all">
                    ‚úÖ Finalizadas
                </button>
                <button onclick="filterCitas('cancelada')" id="filter-cancelada"
                    class="px-4 py-2 rounded-lg font-bold text-sm bg-white text-gray-500 hover:text-primary border border-gray-100 transition-all">
                    ‚ùå Rechazadas
                </button>
                <button onclick="filterCitas('all')" id="filter-all"
                    class="px-4 py-2 rounded-lg font-bold text-sm bg-white text-gray-500 hover:text-primary border border-gray-100 transition-all">
                    üìÇ Todas
                </button>
            </div>

            <div class="bg-white rounded-[2rem] shadow-lg p-6 border border-gray-100">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex justify-between items-center">
                    <span id="citas-title">Citas de Hoy</span>
                    <span id="citas-count" class="text-sm bg-gray-100 text-gray-600 px-3 py-1 rounded-full">0</span>
                </h2>

                <!-- Container for Cards/Table -->
                <div id="citas-container" class="space-y-4">
                    <!-- Cards will be injected here -->
                    <div class="text-center py-8 text-gray-400">Cargando...</div>
                </div>
            </div>
        </div>

        <!-- HORARIOS SECTION -->
        <div id="tab-horarios" class="hidden space-y-6">
            <div class="bg-white rounded-[2rem] shadow-lg p-6 border border-gray-100">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Horarios de Atenci√≥n</h2>
                <div id="horarios-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Cards populated by JS -->
                </div>
            </div>
        </div>

        <!-- BLOQUEOS SECTION -->
        <div id="tab-bloqueos" class="hidden space-y-6">
            <div class="bg-white rounded-[2rem] shadow-lg p-6 border border-gray-100">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">D√≠as Bloqueados</h2>
                    <form id="bloqueo-form" class="flex gap-2">
                        <input type="date" name="fecha" required
                            class="px-4 py-2 rounded-xl bg-gray-50 border border-gray-200">
                        <button type="submit"
                            class="bg-red-500 text-white px-4 py-2 rounded-xl font-bold hover:bg-red-600 transition-colors">
                            <i class="fas fa-plus"></i> Bloquear
                        </button>
                    </form>
                </div>
                <div id="bloqueos-list" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- USERS SECTION -->
        <div id="tab-users" class="hidden space-y-6">
            <div class="bg-white rounded-[2rem] shadow-lg p-6 border border-gray-100 overflow-x-auto">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Usuarios Registrados</h2>
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-gray-400 border-b border-gray-100">
                            <th class="py-4 font-normal">ID</th>
                            <th class="py-4 font-normal">Nombre</th>
                            <th class="py-4 font-normal">Username/Email</th>
                            <th class="py-4 font-normal">Tel√©fono</th>
                            <th class="py-4 font-normal">Rol</th>
                            <th class="py-4 font-normal">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body" class="text-gray-600">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Tab Switching
    function switchAdminTab(tabName) {
        ['citas', 'horarios', 'bloqueos', 'users'].forEach(t => {
            document.getElementById(`tab-${t}`).classList.add('hidden');
            const btn = document.getElementById(`btn-${t}`);
            btn.className = "px-6 py-3 rounded-xl font-bold transition-all text-gray-500 hover:text-primary hover:bg-pink-50";
        });
        document.getElementById(`tab-${tabName}`).classList.remove('hidden');
        document.getElementById(`btn-${tabName}`).className = "px-6 py-3 rounded-xl font-bold transition-all bg-primary text-white shadow-md";

        // Load data on switch
        if (tabName === 'citas') loadCitas();
        if (tabName === 'horarios') loadHorarios();
        if (tabName === 'bloqueos') loadBloqueos();
        if (tabName === 'users') loadUsers();
    }

    // --- CITAS ---
    let allCitas = [];
    let currentCitasFilter = 'hoy';

    async function loadCitas() {
        try {
            const res = await api.get('/citas/');
            allCitas = res;
            filterCitas(currentCitasFilter);
        } catch (e) { console.error(e); }
    }

    function filterCitas(filter) {
        currentCitasFilter = filter;

        // Update Buttons UI
        ['hoy', 'pendiente', 'completada', 'cancelada', 'all'].forEach(f => {
            const btn = document.getElementById(`filter-${f}`);
            if (f === filter) {
                btn.className = "px-4 py-2 rounded-lg font-bold text-sm bg-primary text-white shadow transition-all";
            } else {
                btn.className = "px-4 py-2 rounded-lg font-bold text-sm bg-white text-gray-500 hover:text-primary border border-gray-100 transition-all";
            }
        });

        const todayStr = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
        let filtered = [];

        // Filter Logic
        if (filter === 'hoy') {
            document.getElementById('citas-title').textContent = "Citas para Hoy (Confirmadas)";
            filtered = allCitas.filter(c => c.fecha_cita === todayStr && c.estado === 'confirmada');
        } else if (filter === 'all') {
            document.getElementById('citas-title').textContent = "Todas las Citas";
            filtered = allCitas;
        } else {
            document.getElementById('citas-title').textContent = `Citas: ${filter.charAt(0).toUpperCase() + filter.slice(1)}s`;
            filtered = allCitas.filter(c => c.estado === filter);
        }

        document.getElementById('citas-count').textContent = filtered.length;
        renderCitas(filtered);
    }

    function renderCitas(citas) {
        const container = document.getElementById('citas-container');
        if (citas.length === 0) {
            container.innerHTML = '<div class="text-center py-8 text-gray-400">No hay citas en esta categor√≠a.</div>';
            return;
        }

        container.innerHTML = citas.map(c => {
            const dateObj = new Date(c.fecha_cita + 'T00:00:00');
            const dateStr = dateObj.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' });
            const whatsappLink = c.cliente_telefono ? `https://wa.me/${c.cliente_telefono.replace(/\D/g, '')}` : '#';

            return `
                <div class="bg-gray-50 rounded-2xl p-4 border border-gray-100 transition-all hover:shadow-md">
                    <!-- Header: Top info -->
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">${c.cliente_nombre || 'Cliente'}</h3>
                            <p class="text-primary font-medium text-sm flex items-center gap-2">
                                <i class="fas fa-magic text-xs"></i> ${c.servicio ? c.servicio.nombre_servicio : 'Borrado'}
                            </p>
                        </div>
                        <span class="px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-wider
                            ${c.estado === 'confirmada' ? 'bg-green-100 text-green-700' :
                    c.estado === 'cancelada' ? 'bg-red-100 text-red-700' :
                        c.estado === 'completada' ? 'bg-blue-100 text-blue-700' : 'bg-yellow-100 text-yellow-700'}">
                            ${c.estado}
                        </span>
                    </div>

                    <!-- Body: Appointment details -->
                    <div class="flex items-center justify-between text-sm text-gray-500 mb-4 bg-white/50 p-3 rounded-xl border border-white">
                        <div class="flex items-center gap-3">
                            <div class="bg-pink-100 text-primary w-10 h-10 rounded-lg flex flex-col items-center justify-center font-bold">
                                <span class="text-[10px] uppercase leading-none">${dateStr.split(' ')[0]}</span>
                                <span class="text-sm leading-none">${dateStr.split(' ')[1]}</span>
                            </div>
                            <div>
                                <p class="font-bold text-gray-700">${dateStr}</p>
                                <p class="text-xs italic">${c.hora_inicio.substring(0, 5)} hs</p>
                            </div>
                        </div>
                        
                        <div class="flex gap-2">
                            ${c.cliente_telefono ? `
                                <a href="${whatsappLink}" target="_blank" class="w-10 h-10 bg-green-500 text-white rounded-full flex items-center justify-center shadow-lg hover:scale-110 transition-transform" title="WhatsApp">
                                    <i class="fab fa-whatsapp text-xl"></i>
                                </a>
                            ` : ''}
                            <button onclick="toggleDetails(${c.id})" class="w-10 h-10 bg-gray-100 text-gray-400 rounded-full flex items-center justify-center hover:bg-gray-200 transition-colors" title="Detalles">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Hidden Details Section -->
                    <div id="details-${c.id}" class="hidden mt-3 pt-3 border-t border-dashed border-gray-200 text-xs text-gray-500 space-y-1">
                        <p><strong>ID Cita:</strong> #${c.id}</p>
                        <p><strong>Email:</strong> ${c.cliente_email || '-'}</p>
                        <p><strong>Tel√©fono:</strong> ${c.cliente_telefono || '-'}</p>
                        ${c.notas ? `<p><strong>Notas:</strong> ${c.notas}</p>` : ''}
                    </div>

                    <!-- Footer: Actions -->
                    <div class="flex gap-2 justify-end mt-2">
                         ${c.estado === 'pendiente' ? `
                            <button onclick="updateStatus(${c.id}, 'confirmada')" class="flex-1 py-2 bg-green-500 text-white rounded-xl font-bold text-sm shadow-sm hover:bg-green-600 transition-colors">
                                <i class="fas fa-check mr-1"></i> Aprobar
                            </button>
                            <button onclick="updateStatus(${c.id}, 'cancelada')" class="flex-1 py-2 bg-gray-100 text-gray-500 rounded-xl font-bold text-sm hover:bg-red-50 hover:text-red-500 transition-colors">
                                <i class="fas fa-times mr-1"></i> Rechazar
                            </button>
                        ` : ''}

                        ${c.estado === 'confirmada' ? `
                            <button onclick="updateStatus(${c.id}, 'completada')" class="flex-1 py-2 bg-blue-500 text-white rounded-xl font-bold text-sm shadow-sm hover:bg-blue-600 transition-colors">
                                <i class="fas fa-calendar-check mr-1"></i> Finalizar
                            </button>
                            <button onclick="updateStatus(${c.id}, 'cancelada')" class="px-4 py-2 bg-red-50 text-red-400 rounded-xl font-medium text-sm hover:bg-red-100 transition-colors">
                                <i class="fas fa-ban"></i>
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }).join('');
    }

    function toggleDetails(id) {
        const el = document.getElementById(`details-${id}`);
        el.classList.toggle('hidden');
    }

    async function updateStatus(id, newStatus) {
        if (!confirm(`¬øCambiar estado a ${newStatus}?`)) return;
        try {
            await api.put(`/citas/${id}`, { estado: newStatus });
            loadCitas();
        } catch (e) { alert(e.message); }
    }

    // --- HORARIOS ---
    async function loadHorarios() {
        try {
            const horarios = await api.get('/configuracion/horarios');
            const grid = document.getElementById('horarios-grid');
            const days = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado']; // JS 0-6

            grid.innerHTML = horarios.map(h => `
                <div class="bg-gray-50 rounded-xl p-4 border border-gray-100">
                    <div class="flex justify-between items-center mb-3">
                        <span class="font-bold text-lg text-gray-700">${days[h.dia_semana]}</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" ${h.activo ? 'checked' : ''} onchange="updateHorario(${h.id}, this.checked, '${h.hora_inicio}', '${h.hora_fin}')" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                        </label>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <span class="text-xs text-gray-400">Apertura</span>
                            <input type="time" value="${h.hora_inicio}" onchange="updateHorario(${h.id}, ${h.activo}, this.value, '${h.hora_fin}')" class="w-full mt-1 px-3 py-2 rounded-lg border border-gray-200 text-sm">
                        </div>
                        <div>
                            <span class="text-xs text-gray-400">Cierre</span>
                            <input type="time" value="${h.hora_fin}" onchange="updateHorario(${h.id}, ${h.activo}, '${h.hora_inicio}', this.value)" class="w-full mt-1 px-3 py-2 rounded-lg border border-gray-200 text-sm">
                        </div>
                    </div>
                </div>
            `).join('');
        } catch (e) { console.error(e); }
    }

    async function updateHorario(id, activo, start, end) {
        try {
            await api.put(`/configuracion/horarios/${id}`, {
                hora_inicio: start,
                hora_fin: end,
                activo: activo
            });
            // Optional: visual feedback
        } catch (e) { alert("Error actualizando horario"); loadHorarios(); }
    }

    // --- BLOQUEOS ---
    async function loadBloqueos() {
        try {
            const bloqueos = await api.get('/configuracion/bloqueos');
            document.getElementById('bloqueos-list').innerHTML = bloqueos.map(b => `
                <div class="bg-red-50 p-4 rounded-xl flex justify-between items-center border border-red-100">
                    <div>
                        <span class="font-bold text-red-700">${new Date(b.fecha + 'T00:00:00').toLocaleDateString()}</span>
                        <p class="text-xs text-red-400">Bloqueado</p>
                    </div>
                    <button onclick="deleteBloqueo(${b.id})" class="text-red-400 hover:text-red-700"><i class="fas fa-trash"></i></button>
                </div>
            `).join('');
        } catch (e) { }
    }

    document.getElementById('bloqueo-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const date = e.target.fecha.value;
        try {
            await api.post('/configuracion/bloqueos', { fecha: date, motivo: 'Admin' });
            e.target.reset();
            loadBloqueos();
        } catch (e) { alert(e.message); }
    });

    async function deleteBloqueo(id) {
        if (!confirm('¬øDesbloquear fecha?')) return;
        await api.delete(`/configuracion/bloqueos/${id}`);
        loadBloqueos();
    }

    // --- USERS ---
    async function loadUsers() {
        try {
            const users = await api.get('/usuarios/');
            document.getElementById('users-table-body').innerHTML = users.map(u => `
                 <tr class="border-b border-gray-50">
                    <td class="py-4 font-bold">#${u.id}</td>
                    <td class="py-4">${u.name || '-'}</td>
                    <td class="py-4 text-sm">${u.username}<br>${u.email || ''}</td>
                    <td class="py-4">${u.phone || '-'}</td>
                    <td class="py-4">
                        <span class="px-2 py-1 rounded text-xs font-bold ${u.usr_lvl === 1 ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-600'}">
                            ${u.usr_lvl === 1 ? 'ADMIN' : 'CLIENTE'}
                        </span>
                    </td>
                    <td class="py-4">
                        ${u.usr_lvl !== 1 ? `
                            <button onclick="toggleAdmin(${u.id}, 1)" class="text-xs bg-purple-50 text-purple-600 px-3 py-1 rounded hover:bg-purple-100">Hacer Admin</button>
                        ` : `
                            <button onclick="toggleAdmin(${u.id}, 2)" class="text-xs bg-gray-50 text-gray-600 px-3 py-1 rounded hover:bg-gray-100">Quitar Admin</button>
                        `}
                    </td>
                </tr>
            `).join('');
        } catch (e) { }
    }

    async function toggleAdmin(id, newLvl) {
        if (!confirm('¬øCambiar rol de usuario?')) return;
        await api.put(`/usuarios/${id}/level`, { usr_lvl: newLvl });
        loadUsers();
    }

    // Init
    document.addEventListener('DOMContentLoaded', () => loadCitas());

</script>
{% endblock %}